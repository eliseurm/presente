<crud #crudRef [parent]="vm" listToolbarTitle="Imagens" editToolbarTitle="Editar Imagem"
      [collapsibleFilters]="true" [showListCloseButton]="true"
      (saveButtonAction)="onBeforeSaveHandleUpload($event)"
      (closeButtonAction)="onCloseCrud()">

  <!-- Filtros -->
  <div crud-list-filter-fields class="w-full text-left">
    <crud-filter
      [filter]="vm.filter"
      [fields]="filterFields"
      [loading]="false"
      (onSearch)="vm.doFilter().subscribe()"
      (onClear)="vm.filter = vm['newFilter'](); vm.doFilter().subscribe()"
    ></crud-filter>
  </div>

  <!-- Grid de listagem -->
  <div crud-list-grid class="w-full">
    <e-data-grid
      [dataSource]="vm.dataSource"
      [paginator]="true"
      [rows]="vm.filter.size || 10"
      [rowsPerPageOptions]="[10,20,50,100]"
      [totalRecords]="vm.totalRecords"
      [lazy]="true"
      (onLazyLoad)="onLazyLoad($event)"
      (rowDblClick)="crudRef.onRowDblClick($event)">

      <ei-column dataField="nome" caption="Nome"></ei-column>
      <ei-column dataField="imagem" caption="Imagem" cellTemplate="imgTpl"></ei-column>
      <ei-column dataField="acoes" caption="Ações" cellTemplate="acoesTpl"></ei-column>

      <ng-template eTemplate="imgTpl" let-row>
        <img *ngIf="getThumbUrl(row) as src" [src]="src" alt="thumb" style="width:60px;height:60px;object-fit:cover;border-radius:4px;border:1px solid #ddd;" />
      </ng-template>

      <ng-template eTemplate="acoesTpl" let-row>
        <button pButton type="button" icon="pi pi-pencil" class="p-button-text p-button-sm" aria-label="Editar"
                (click)="crudRef.onRowDblClick(row)"></button>
      </ng-template>

    </e-data-grid>
  </div>

  <!-- Formulário de edição -->
  <div crud-edit-template class="grid grid-cols-1 gap-4 text-left justify-items-start w-full">
    <div class="grid grid-cols-1 gap-4 md:grid-cols-2 w-full">
      <div class="flex flex-col gap-2 w-full">
        <label class="block">Nome *</label>
        <input class="w-full" pInputText type="text" [(ngModel)]="vm.model.nome" name="nome" />
      </div>
      <div class="flex flex-col gap-2 w-full md:col-span-2">
        <label class="block">Arquivo</label>
        <div class="flex items-center gap-3">
          <input #fileInput type="file" accept="image/*" (change)="onFileSelected($event)" style="display:none" />
          <button pButton type="button" label="Selecionar Imagem" icon="pi pi-upload" (click)="fileInput.click()"></button>
          <span *ngIf="tempFile?.name" style="font-size:0.9rem;color:#555;">{{ tempFile?.name }}</span>
        </div>
        <div class="flex gap-4 items-start mt-2">
          <img *ngIf="previewUrl; else currentPreview" [src]="previewUrl" alt="preview" style="max-width:200px;max-height:200px;border:1px solid #ddd;border-radius:4px;" />
          <ng-template #currentPreview>
            <img *ngIf="getThumbUrl(vm.model) as src" [src]="src" alt="atual" style="max-width:200px;max-height:200px;border:1px solid #ddd;border-radius:4px;" />
          </ng-template>
        </div>
      </div>
    </div>
  </div>

</crud>

<p-toast position="top-right" [breakpoints]="{'920px': {width: '100%', right: '0', left: '0'}}"></p-toast>
