<crud #crudRef [parent]="vm" listToolbarTitle="Eventos" editToolbarTitle="Editar Evento"
      [collapsibleFilters]="true" [showListCloseButton]="true" (closeButtonAction)="onCloseCrud()">

    <div crud-list-filter-fields class="w-full text-left">
        <crud-filter
            [filter]="vm.filter"
            [fields]="filterFields"
            [loading]="false"
            (onSearch)="vm.doFilter().subscribe()"
            (onClear)="onClearFilters()"
        ></crud-filter>
    </div>

    <div crud-list-grid class="w-full">
        <e-data-grid
            [dataSource]="vm.dataSource"
            [loading]="loading"
            [paginator]="true"
            [rows]="vm.filter.size || 10"
            [rowsPerPageOptions]="[10,20,50,100]"
            [totalRecords]="vm.totalRecords"
            [lazy]="true"
            (onLazyLoad)="onEventoLazyLoad($event)"
            (rowDblClick)="crudRef.onRowDblClick($event)">

            <ei-column dataField="cliente" caption="Cliente" cellTemplate="clienteTpl"></ei-column>
            <ei-column dataField="nome" caption="Nome"></ei-column>
            <ei-column dataField="status" caption="Status" cellTemplate="statusTpl"></ei-column>
            <ei-column dataField="fimPrevisto" caption="Previsto" cellTemplate="dataTpl"></ei-column>
            <ei-column dataField="inicio" caption="Início" cellTemplate="dataTpl"></ei-column>
            <ei-column dataField="fim" caption="Fim" cellTemplate="dataTpl"></ei-column>
            <ei-column dataField="acoes" caption="Ações" cellTemplate="acoesTpl"></ei-column>

            <ng-template eTemplate="clienteTpl" let-data="data">{{ data.nome || '-' }}</ng-template>
            <ng-template eTemplate="statusTpl" let-row="row">{{ getStatusDescricao(row?.status) }}</ng-template>
            <ng-template eTemplate="dataTpl" let-data="data">{{ data | date:'short' }}</ng-template>

            <ng-template eTemplate="acoesTpl" let-row>
                <button pButton type="button" icon="pi pi-pencil" class="p-button-text p-button-sm" aria-label="Editar"
                        (click)="crudRef.onRowDblClick(row)"></button>
            </ng-template>

        </e-data-grid>
    </div>

    <div crud-edit-template class="grid grid-cols-1 gap-4 text-left justify-items-start w-full">
        <p-tabs [value]="abaAtiva" class="w-full" (valueChange)="onTabChangePrincipal($event)">
            <p-tablist>
                <p-tab value="geral">Geral</p-tab>
                <p-tab value="pessoa">Pessoas</p-tab>
                <p-tab value="produto">Produtos</p-tab>
                @if (importacaoLogs.length > 0) {
                <p-tab value="log">
                    <span class="text-red-500 font-bold flex items-center gap-2">
                        <i class="pi pi-exclamation-triangle"></i> Log Erros ({{ importacaoLogs.length }})
                    </span>
                </p-tab>
                }

            </p-tablist>

            <p-tabpanels>

                <p-tabpanel value="geral">
<!--
                    @if (vm.model.id) {
                        <div class="flex gap-2 items-center mb-2">
                            <button pButton type="button" label="Iniciar"
                                    icon="pi pi-play"
                                    class="p-button-success"
                                    (click)="onIniciarEvento()"></button>
                            <button pButton type="button" label="Pausar"
                                    icon="pi pi-pause"
                                    class="p-button-warning"
                                    (click)="onPausarEvento()"></button>
                            <button pButton type="button" label="Parar"
                                    icon="pi pi-stop"
                                    class="p-button-danger"
                                    (click)="onPararEvento()"></button>

                            @if (vm.model.inicio) {
                                <span class="text-sm opacity-70">Iniciado: {{ vm.model.inicio | date:'short' }}</span>
                            }

                            @if (vm.model.fim) {
                                <span class="text-sm opacity-70">• Fim: {{ vm.model.fim | date:'short' }}</span>
                            }
                        </div>
                    }
-->

                    <div class="grid grid-cols-1 gap-4 md:grid-cols-2">
                        <div class="flex flex-col gap-2 w-full md:w-3/4">
                            <label class="block">Nome *</label>
                            <input class="w-full" pInputText type="text" [(ngModel)]="vm.model.nome" name="nome"/>
                        </div>
                        <div class="flex flex-col gap-2 w-full md:w-1/2">
                            <label class="block">Status *</label>
                            <enum-select class="w-full"
                                         [enumObject]="statusEnumType"
                                         [(ngModel)]="vm.model.status"
                                         name="status"
                            ></enum-select>
                        </div>
                        <div class="flex flex-col gap-2 w-full md:w-1/2">
                            <label class="block">Cliente *</label>
                            <p-select class="w-full"
                                      optionLabel="nome"
                                      dataKey="id"
                                      name="cliente"
                                      placeholder="Selecione"
                                      [options]="clientesOptions"
                                      [(ngModel)]="vm.model.cliente"
                            ></p-select>
                        </div>
                        <div class="flex flex-col gap-2 w-full md:w-1/2">
                            <label class="block">Início</label>
                            <p-datepicker class="w-full"
                                          [(ngModel)]="vm.model.inicio"
                                          name="inicio"
                                          inputId="inicio"
                                          [showClear]="true"
                                          [showTime]="true"
                                          hourFormat="24"
                                          [showIcon]="true"
                                          iconDisplay="input"
                                          [touchUI]="false"
                                          appendTo="body"
                                          [baseZIndex]="9999"></p-datepicker>
                        </div>
                        <div class="flex flex-col gap-2 w-full md:w-1/2">
                            <label class="block">Fim Previsto</label>
                            <p-datepicker class="w-full"
                                          [(ngModel)]="vm.model.fimPrevisto"
                                          name="fimPrevisto"
                                          inputId="fimPrevisto"
                                          [showClear]="true"
                                          [showTime]="true"
                                          hourFormat="24"
                                          [showIcon]="true"
                                          iconDisplay="input"
                                          [touchUI]="false"
                                          appendTo="body"
                                          [baseZIndex]="9999"></p-datepicker>
                        </div>
                        <div class="flex flex-col gap-2 w-full md:w-1/2">
                            <label class="block">Fim</label>
                            <p-datepicker class="w-full"
                                          [(ngModel)]="vm.model.fim"
                                          name="fim"
                                          inputId="fim"
                                          [showClear]="true"
                                          [showTime]="true"
                                          hourFormat="24"
                                          [showIcon]="true"
                                          iconDisplay="input"
                                          [touchUI]="false"
                                          appendTo="body"
                                          [baseZIndex]="9999"
                            ></p-datepicker>
                        </div>
                        <div class="flex flex-col gap-2 w-full md:col-span-2">
                            <label class="block">Descrição</label>
                            <textarea class="w-full" pInputText rows="3" [(ngModel)]="vm.model.descricao"
                                      name="descricao"></textarea>
                        </div>
                        <div class="flex flex-col gap-2 w-full md:col-span-2">
                            <label class="block">Anotações</label>
                            <textarea class="w-full" pInputText rows="3" [(ngModel)]="vm.model.anotacoes"
                                      name="anotacoes"></textarea>
                        </div>
                    </div>
                </p-tabpanel>

                <p-tabpanel value="pessoa">
                    <div class="flex flex-col gap-3 mb-3">
                        <div class="flex items-center justify-between">

                            <div>
                                <div>
                                    <input #fileInput type="file" accept=".csv" class="hidden"
                                           (change)="onImportaArquivoCsv($event)"/>

                                    <p-menu #menuPessoas [model]="itemsMenuPessoas" [popup]="true"></p-menu>

                                    <button pButton type="button"
                                            (click)="menuPessoas.toggle($event)"
                                            icon="pi pi-bars"
                                            label="Ações"
                                            class="p-button-outlined p-button-secondary">
                                    </button>
                                </div>
                            </div>

                            <div class="flex items-center gap-2">
                                <button pButton type="button" label="Refresh" icon="pi pi-refresh"
                                        (click)="onRefreshGridPessoas()"
                                ></button>
                                <button pButton type="button" label="Adicionar" icon="pi pi-plus"
                                        (click)="onPopupPessoaAbre()"
                                ></button>
                                <button pButton type="button" label="Excluir" icon="pi pi-trash" severity="danger"
                                        [disabled]="!selectedPessoas.length"
                                        (click)="onDeletaEventoPessoaBloco()"
                                ></button>
                            </div>
                        </div>

                        @if (progressoTarefaDto.progresso) {
                            <div class="mt-4 p-3 border rounded-lg bg-gray-50 shadow-sm flex flex-row items-center gap-4">
                                <div class="flex-1">
                                    <p-progressbar [value]="progressoTarefaDto.percentual" [showValue]="false" [style]="{ height: '10px' }"></p-progressbar>
                                </div>
                                <span class="text-xs font-bold text-blue-600 whitespace-nowrap">{{ progressoTarefaDto.atual }} / {{ progressoTarefaDto.total }}</span>
                                <button pButton
                                        class="p-button-danger p-button-text p-button-sm"
                                        icon="pi pi-stop"
                                        label="Parar"
                                        (click)="pararProcesso()"
                                ></button>
                            </div>
                        }

                        <p-panel header="Filtros de Pessoas" [toggleable]="true" [collapsed]="true" class="mb-3">
                            <div class="flex flex-col gap-3 p-3 border rounded surface-ground bg-gray-50">
                                <div class="flex flex-wrap gap-2 items-center w-full">
                                    <span class="p-input-icon-left flex-1 min-w-[200px]">
                                        <i class="pi pi-search"></i>
                                        <input pInputText type="search" class="w-full p-inputtext-sm"
                                               placeholder="Buscar por Nome..."
                                               [(ngModel)]="filterEventoPessoa.pessoaNome"
                                               (input)="onSearchInput()"
                                               (search)="filtrarPessoasLocalmente()"/>
                                    </span>

                                    <span class="p-input-icon-left flex-1 min-w-[200px]">
                                        <i class="pi pi-id-card"></i>
                                        <input pInputText type="search" class="w-full p-inputtext-sm"
                                               placeholder="Buscar por CPF..."
                                               [(ngModel)]="filterEventoPessoa.pessoaCpf"
                                               (input)="onSearchInput()"
                                               (search)="filtrarPessoasLocalmente()"/>
                                    </span>
                                </div>

                                <div class="flex flex-wrap gap-4 items-center w-full mt-2">

                                    <div class="flex flex-col gap-1">
                                        <label class="text-xs font-semibold text-gray-600">Já fizeram escolha?</label>
                                        <p-selectButton [options]="opcoesTriState"
                                                        [(ngModel)]="filterEventoPessoa.jaEscolheu"
                                                        (onChange)="filtrarPessoasLocalmente()"
                                                        styleClass="p-selectbutton-sm">
                                        </p-selectButton>
                                    </div>

                                    <div class="flex flex-col gap-1">
                                        <label class="text-xs font-semibold text-gray-600">Tem link mágico?</label>
                                        <p-selectButton [options]="opcoesTriState"
                                                        [(ngModel)]="filterEventoPessoa.temLinkMagico"
                                                        (onChange)="filtrarPessoasLocalmente()"
                                                        styleClass="p-selectbutton-sm">
                                        </p-selectButton>
                                    </div>

                                    <div class="flex-1 text-right self-end">
                                        <button pButton type="button" icon="pi pi-filter"
                                                class="p-button-outlined"
                                                pTooltip="Filtrar"
                                                (click)="filtrarPessoasLocalmente()">
                                        </button>
                                    </div>
                                </div>

                                <div class="w-full text-left text-sm text-gray-500 font-medium border-t pt-2">
                                    Total: {{ filterEventoPessoa.totalItens }}
                                </div>
                            </div>
                        </p-panel>

                    </div>

                    <e-data-grid #gridPessoas
                                 [dataSource]="pessoasGridDisplay || []"
                                 [loading]="loadingPessoas"
                                 [paginator]="true"
                                 [rows]="10"
                                 [rowsPerPageOptions]="[10, 20, 50, 100]"
                                 [lazy]="false"
                                 [showMessageDefault]="false"
                                 (onEditDialogOpen)="onEditaEventoPessoa($event)"
                                 (onSaving)="onSalvingEditEventoPessoa($event)"
                                 (onDeleting)="onDeletaEventoPessoa($event)"
                                 [showSelection]="true"
                                 [(selection)]="selectedPessoas"
                    >

                        <eo-editing mode="popup" [allowAdding]="false" [allowUpdating]="true" [allowDeleting]="true"
                                    [confirmDelete]="true">

                            <e-popup title="Pessoa do Evento" [showTitle]="true" width="900px" height="auto"></e-popup>

                            <eo-form [colCount]="1" [useContentProjection]="true">
                                <p-tabs value="epGeral" class="w-full">
                                    <p-tablist>
                                        <p-tab value="epGeral">Geral</p-tab>
                                        <p-tab value="epEscolhaAtual">Escolha atual</p-tab>
                                        <p-tab value="epHistorico">Historico</p-tab>
                                    </p-tablist>
                                    <p-tabpanels>
                                        <p-tabpanel value="epGeral">
                                            <ei-item dataField="pessoa.nome" label="Nome" editorType="template"></ei-item>
                                            <ei-item dataField="pessoa.cpf" label="Cpf" editorType="template"></ei-item>
                                            <ei-item dataField="pessoa.telefone" label="Telefone" editorType="template"></ei-item>
                                            <ei-item dataField="pessoa.email" label="e-Mail" editorType="template"></ei-item>
                                            <ei-item dataField="status" label="Status" editorType="template"></ei-item>
                                        </p-tabpanel>

                                        <p-tabpanel header="Escolha Atual" value="epEscolhaAtual">

                                            <div class="w-full overflow-y-auto max-h-[60vh] md:max-h-none pr-1">

                                                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 w-full">

                                                    <div class="flex flex-col gap-3">
                                                        <div class="text-lg font-bold border-b pb-1 mb-2">Detalhes da Escolha</div>

                                                        <div class="flex gap-2">
                                                            <span class="font-semibold w-24">Data:</span>
                                                            <span>{{ pessoaUltimaEscolha?.dataEscolha | date:'dd/MM/yyyy HH:mm' }}</span>
                                                        </div>
                                                        <div class="flex gap-2">
                                                            <span class="font-semibold w-24">Produto:</span>
                                                            <span>{{ pessoaUltimaEscolha?.produto?.nome || pessoaUltimaEscolha?.produto?.id }}</span>
                                                        </div>
                                                        <div class="flex gap-2">
                                                            <span class="font-semibold w-24">Tamanho:</span>
                                                            <span>{{ pessoaUltimaEscolha?.tamanho?.tamanho || pessoaUltimaEscolha?.tamanho?.id }}</span>
                                                        </div>
                                                        <div class="flex gap-2">
                                                            <span class="font-semibold w-24">Cor:</span>
                                                            <span>{{ pessoaUltimaEscolha?.cor?.nome || pessoaUltimaEscolha?.cor?.id }}</span>
                                                        </div>
                                                        <div class="flex gap-2">
                                                            <span class="font-semibold w-24">Preço:</span>
                                                            <span class="text-green-600 font-bold">
                        {{ pessoaUltimaEscolha?.produto?.preco | currency:'BRL' }}
                    </span>
                                                        </div>
                                                    </div>

                                                    <div class="flex flex-col justify-start">
                                                        <div class="text-lg font-bold border-b pb-1 mb-2">Imagens</div>

                                                        <div *ngIf="loadingImagens; else conteudoImagens" class="flex items-center justify-center h-40 bg-gray-50 border rounded">
                                                            <p-progressSpinner
                                                                styleClass="w-10 h-10"
                                                                strokeWidth="4"
                                                                fill="var(--surface-ground)"
                                                                animationDuration=".5s">
                                                            </p-progressSpinner>
                                                        </div>

                                                        <ng-template #conteudoImagens>

                                                            <div *ngIf="pessoaUltimaEscolha?.produto?.imagens?.length; else semImagem">
                                                                <p-galleria
                                                                    [value]="pessoaUltimaEscolha?.produto?.imagens"
                                                                    [responsiveOptions]="[{breakpoint: '1024px',numVisible: 5},{breakpoint: '768px',numVisible: 3},{breakpoint: '560px',numVisible: 1}]"
                                                                    [containerStyle]="{'max-width': '100%'}"
                                                                    [numVisible]="4"
                                                                    [circular]="true"
                                                                    [showItemNavigators]="true"
                                                                    [showThumbnails]="true"
                                                                    [autoPlay]="false">

                                                                    <ng-template pTemplate="item" let-item>
                                                                        <img [src]="item.url"
                                                                             [alt]="item.nome"
                                                                             class="w-full block object-contain max-h-[250px] md:max-h-[400px]" />
                                                                    </ng-template>

                                                                    <ng-template pTemplate="thumbnail" let-item>
                                                                        <div class="grid gap-1 justify-center">
                                                                            <img [src]="item.url" [alt]="item.nome"
                                                                                 style="width: 50px; height: 50px; display: block; object-fit: cover;" />
                                                                        </div>
                                                                    </ng-template>

                                                                </p-galleria>
                                                            </div>

                                                            <ng-template #semImagem>
                                                                <div class="flex items-center justify-center h-32 bg-gray-50 border border-dashed border-gray-300 rounded text-gray-400">
                                                                    <i class="pi pi-image mr-2 text-2xl"></i>
                                                                    <span>Sem imagens disponíveis para este produto.</span>
                                                                </div>
                                                            </ng-template>

                                                        </ng-template>

                                                    </div>

                                                </div>

                                            </div>
                                        </p-tabpanel>

                                        <p-tabpanel value="epHistorico">
                                            <e-data-grid [dataSource]="pessoaHistorico" [scrollable]="true"
                                                         scrollHeight="400px">
                                                <ei-column dataField="dataEscolha" caption="Escolha"
                                                           cellTemplate="dataTemplate"></ei-column>
                                                <ei-column dataField="alteradoEm" caption="Alterado em"
                                                           cellTemplate="dataTemplate"></ei-column>
                                                <ei-column dataField="eventoNome" caption="Evento"></ei-column>
                                                <ei-column dataField="produtoNome" caption="Produto"></ei-column>
                                                <ei-column dataField="corNome" caption="Cor"></ei-column>
                                                <ei-column dataField="tamanhoDescricao" caption="Tamanho"></ei-column>
                                                <ng-template eTemplate="dataTemplate"
                                                             let-data="data">{{ data | date:'dd/MM/yyyy hh:mm' }}
                                                </ng-template>
                                            </e-data-grid>
                                        </p-tabpanel>
                                    </p-tabpanels>
                                </p-tabs>
                            </eo-form>
                        </eo-editing>

                        <ei-column dataField="pessoa.nome" caption="Pessoa" editCellTemplate="inputEditCellTemplate"></ei-column>
                        <ei-column dataField="pessoa.cpf" caption="CPF" editCellTemplate="inputEditCellTemplate">></ei-column>
                        <ei-column dataField="pessoa.telefone" editCellTemplate="inputEditCellTemplate" [visible]="false"></ei-column>
                        <ei-column dataField="pessoa.email" editCellTemplate="inputEditCellTemplate" [visible]="false"></ei-column>
                        <ei-column dataField="status" caption="Status" editCellTemplate="statusEditCellTemplate" cellTemplate="statusCellTemplate"></ei-column>
                        <ei-column dataField="jaEscolheu" caption="Já escolheu" cellTemplate="jaEscolheuTpl"></ei-column>
                        <ei-column dataField="nomeMagicNumber" caption="Link mágico" cellTemplate="magicLinkCell"></ei-column>
                        <ei-column dataField="nomeMagicNumber" caption="Ações" cellTemplate="acoesCellTemplate"></ei-column>

                        <ng-template eTemplate="statusCellTemplate" let-data="data">{{ statusEnumType[data].descricao }}</ng-template>

                        <ng-template eTemplate="jaEscolheuTpl" let-data="data">
                            <span [title]="data ? 'Já escolheu' : 'Ainda não'">{{ data ? '✔' : '✖' }}</span>
                        </ng-template>

                        <ng-template eTemplate="inputEditCellTemplate" let-dataField="dataField">
                            <input type="text"
                                   pInputText
                                   class="w-full"
                                   [ngModel]="gridPessoas.getFormItemValue(dataField)"
                                   (ngModelChange)="gridPessoas.setFormItemValue(dataField, $event)" />
                        </ng-template>

                        <ng-template eTemplate="statusEditCellTemplate" let-data="data">
                            <enum-select class="w-full"
                                         [enumObject]="statusEnumType"
                                         [ngModel]="data.status"
                                         (ngModelChange)="data.status = $event"
                                         [ngModelOptions]="{standalone:true}">
                            </enum-select>
                        </ng-template>

                        <ng-template eTemplate="magicLinkCell" let-data='data'>
                            @if (data) {
                                <a [href]="buildTokenLink(data)" target="_blank" rel="noopener">{{ data }}</a>
                            }
                            @else {
                                <span class="text-xs opacity-60">—</span>
                            }
                        </ng-template>

                        <ng-template eTemplate="acoesCellTemplate" let-data='data'>
                            <button pButton type="button" icon="pi pi-external-link" class="p-button-text p-button-sm"
                                    pTooltip="Abrir Presente" [disabled]="!data" (click)="abrirPresente(data)"></button>
                            <button pButton type="button" icon="pi pi-copy" class="p-button-text p-button-sm"
                                    pTooltip="Copiar Link" [disabled]="!data" (click)="copiarLink(data)"></button>
                        </ng-template>

                    </e-data-grid>

                    <p-dialog [(visible)]="addPessoasDialogVisible"
                              [modal]="true"
                              [dismissableMask]="false"
                              [closable]="true"
                              header="Adicionar Pessoas"
                              [style]="{width: '900px'}"
                              [breakpoints]="{'960px':'95vw','640px':'95vw'}">

                        <div class="w-full grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div class="flex flex-col gap-2 md:min-w-[220px]">
                                <label class="block mb-2">Pessoas disponíveis</label>
                                <p-listbox class="w-full"
                                           [options]="pessoasPossiveis"
                                           optionLabel="nome"
                                           [filter]="true"
                                           [multiple]="true"
                                           [checkbox]="true"
                                           [metaKeySelection]="false"
                                           [(ngModel)]="pessoasSelecionadasPopup"
                                           name="pessoasSelecionadas">
                                </p-listbox>
                                <small class="opacity-70">Somente pessoas não listadas são exibidas.</small>
                            </div>
                            <div class="flex flex-col gap-2 md:min-w-[220px]">
                                <label class="block">Status</label>
                                <enum-select class="w-full"
                                             [enumObject]="statusEnumType"
                                             [(ngModel)]="statusSelecionadoPopup"
                                             name="statusSelecionado"
                                ></enum-select>
                            </div>
                        </div>

                        <ng-template pTemplate="footer">
                            <div class="flex w-full gap-2 justify-end flex-col sm:flex-row">
                                <button pButton type="button" label="Cancelar" class="p-button-text"
                                        (click)="onPopupPessoaCancela()"></button>
                                <button pButton type="button" label="Adicionar Selecionados" icon="pi pi-check"
                                        class="p-button-success"
                                        [disabled]="pessoasSelecionadasPopup.length === 0 || !statusSelecionadoPopup"
                                        (click)="onPopupPessoaSalva()"></button>
                            </div>
                        </ng-template>
                    </p-dialog>

                </p-tabpanel>

                <p-tabpanel value="produto">
                    <e-data-grid
                        [dataSource]="vm.model.eventoProdutos || []"
                        [loading]="false"
                        (onEditDialogOpen)="onEditingStartProduto($event)"
                        (onSaving)="onSavingProduto($event)"
                        (onDeleting)="onDeletingProduto($event)">

                        <eo-editing mode="popup" [allowAdding]="true" [allowUpdating]="true" [allowDeleting]="true"
                                    [confirmDelete]="true">
                            <e-popup title="Produto do Evento" [showTitle]="true" width="700px" height="auto"></e-popup>
                            <eo-form [colCount]="2">
                                <ei-item dataField="produto" label="Produto" editorType="template">
                                    <ei-validation-rule type="required"
                                                        message="Produto é obrigatório"></ei-validation-rule>
                                </ei-item>
                                <ei-item dataField="status" label="Status" editorType="template">
                                    <ei-validation-rule type="required"
                                                        message="Status é obrigatório"></ei-validation-rule>
                                </ei-item>
                            </eo-form>
                        </eo-editing>

                        <ei-column dataField="produto" caption="Produto" editCellTemplate="produtoEditCellTemplate"
                                   cellTemplate="produtoCellTemplate"></ei-column>
                        <ei-column dataField="status" caption="Status" editCellTemplate="statusEditCellTemplate"
                                   cellTemplate="statusCellTemplate"></ei-column>

                        <ng-template eTemplate="produtoCellTemplate" let-data="data">{{ data.nome }}</ng-template>
                        <ng-template eTemplate="statusCellTemplate" let-data="data">{{ data.descricao }}</ng-template>

                        <ng-template eTemplate="produtoEditCellTemplate" let-row>
                            <p-select class="w-full"
                                      [(ngModel)]="row.produto"
                                      [options]="produtosSugestoes"
                                      optionLabel="nome"
                                      filterBy="nome"
                                      [filter]="true"
                                      (onFilter)="onFilterProdutoSelect($event)"
                                      [loading]="loading"
                                      placeholder="Selecione um Produto"
                                      appendTo="body">
                                <ng-template #footer>
                                    <div (click)="$event.stopPropagation()" class="p-2 border-top-1 surface-border">
                                        <p-paginator
                                            [first]="filtroProduto.page * filtroProduto.size"
                                            [rows]="filtroProduto.size"
                                            [totalRecords]="filtroProduto.totalItens"
                                            (onPageChange)="onPageChangeProdutoPaginator($event)"
                                            [showFirstLastIcon]="false"
                                            [showPageLinks]="true"
                                            [pageLinkSize]="2"
                                            styleClass="p-paginator-sm border-none">
                                        </p-paginator>
                                    </div>
                                </ng-template>
                            </p-select>
                        </ng-template>
                        <ng-template eTemplate="statusEditCellTemplate" let-data="data">
                            <enum-select class="w-full"
                                         [enumObject]="statusEnumType"
                                         [ngModel]="data.status"
                                         (ngModelChange)="data.status = $event"
                                         [ngModelOptions]="{standalone:true}"
                            ></enum-select>
                        </ng-template>
                    </e-data-grid>
                </p-tabpanel>

                <p-tabpanel value="log">
                    <div class="p-4 border border-red-200 rounded bg-red-50">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-red-700 font-bold text-lg">Relatório de Erros na Importação</h3>
                            <button pButton label="Limpar e Fechar" icon="pi pi-times"
                                    class="p-button-danger p-button-text"
                                    (click)="limparLogs()"></button>
                        </div>
                        <div class="max-h-[400px] overflow-y-auto bg-white p-2 border rounded shadow-sm">
                            <ul class="list-none m-0 p-0">
                                @for (log of importacaoLogs; track $index) {
                                    <li class="py-2 border-b border-gray-100 text-sm text-gray-700 flex items-start gap-2">
                                        <i class="pi pi-times-circle text-red-500 mt-0.5"></i>
                                        <span>{{ log }}</span>
                                    </li>
                                }
                            </ul>
                        </div>
                    </div>
                </p-tabpanel>

            </p-tabpanels>
        </p-tabs>
    </div>
</crud>
<p-confirmDialog></p-confirmDialog>
