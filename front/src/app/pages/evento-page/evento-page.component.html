<crud #crudRef [parent]="vm" listToolbarTitle="Eventos" editToolbarTitle="Editar Evento"
      [collapsibleFilters]="true" [showListCloseButton]="true" (closeButtonAction)="onCloseCrud()">

    <div crud-list-filter-fields class="w-full text-left">
        <crud-filter ...></crud-filter>
    </div>
    <div crud-list-grid class="w-full">
        <e-data-grid ...></e-data-grid>
    </div>

    <div crud-edit-template class="grid grid-cols-1 gap-4 text-left justify-items-start w-full">
        <p-tabs [value]="abaAtiva" class="w-full" (valueChange)="onTabChangePrincipal($event)">
            <p-tablist>
                <p-tab value="geral">Geral</p-tab>
                <p-tab value="pessoa">Pessoas</p-tab>
                <p-tab value="produto">Produtos</p-tab>
                <p-tab value="log" *ngIf="importacaoLogs.length > 0">
                    <span class="text-red-500 font-bold flex items-center gap-2">
                        <i class="pi pi-exclamation-triangle"></i> Log Erros ({{importacaoLogs.length}})
                    </span>
                </p-tab>
            </p-tablist>

            <p-tabpanels>

                <p-tabpanel value="geral"> ... </p-tabpanel>

                <p-tabpanel value="pessoa">
                    <div class="flex flex-col gap-3 mb-3">
                        <div class="flex items-center justify-between">
                            <div>
                                <input #fileInput type="file" accept=".csv" class="hidden" (change)="onFileSelect($event)" />
                                <button pButton type="button"
                                        [label]="importando ? 'Processando...' : 'Importar arq csv'"
                                        [icon]="importando ? 'pi pi-spin pi-spinner' : 'pi pi-upload'"
                                        class="p-button-outlined"
                                        [disabled]="importando"
                                        (click)="fileInput.click()">
                                </button>
                            </div>
                            <div class="flex items-center gap-2">
                                <button pButton type="button" label="Refresh" icon="pi pi-refresh" (click)="onRefreshGridPessoas()"></button>
                                <button pButton type="button" label="Adicionar" icon="pi pi-plus" class="p-button-success" (click)="onOpenAddPessoas()"></button>
                            </div>
                        </div>

                        <div class="flex flex-wrap gap-4 p-3 border rounded surface-ground bg-gray-50 items-center">
                            <span class="p-input-icon-left flex-1 min-w-[200px]">
                                <i class="pi pi-search"></i>
                                <input pInputText type="text" class="w-full p-inputtext-sm"
                                       placeholder="Buscar por Nome..."
                                       [(ngModel)]="filtroPessoa.nome"
                                       (keydown.enter)="filtrarPessoasBackend()"
                                       (blur)="filtrarPessoasBackend()" />
                            </span>
                            <span class="p-input-icon-left flex-1 min-w-[200px]">
                                <i class="pi pi-id-card"></i>
                                <input pInputText type="text" class="w-full p-inputtext-sm"
                                       placeholder="Buscar por CPF..."
                                       [(ngModel)]="filtroPessoa.cpf"
                                       (keydown.enter)="filtrarPessoasBackend()"
                                       (blur)="filtrarPessoasBackend()" />
                            </span>
                            <div class="text-sm text-gray-500 whitespace-nowrap">
                                Total: {{ totalPessoas }}
                            </div>
                        </div>
                    </div>

                    <e-data-grid #gridPessoas
                                 [dataSource]="listaPessoasPaginada"
                                 [loading]="loadingPessoas"
                                 [paginator]="true"
                                 [rows]="10"
                                 [rowsPerPageOptions]="[10, 20, 50, 100]"
                                 [lazy]="true"
                                 [totalRecords]="totalPessoas"
                                 (onLazyLoad)="onLazyLoadPessoas($event)"
                                 (onEditDialogOpen)="onEditingStartPessoa($event)"
                                 (onSaving)="onSavingPessoa($event)"
                                 (onDeleting)="onDeletingPessoa($event)">

                        <eo-editing mode="popup" [allowAdding]="false" [allowUpdating]="true" [allowDeleting]="true" [confirmDelete]="true">
                            <e-popup title="Pessoa do Evento" [showTitle]="true" width="900px" height="auto"></e-popup>
                            <eo-form [colCount]="1" [useContentProjection]="true">
                                <p-tabs value="0" class="w-full">
                                </p-tabs>
                            </eo-form>
                        </eo-editing>

                        <ei-column dataField="pessoa" caption="Pessoa" cellTemplate="pessoaCellTemplate" editCellTemplate="pessoaEditCellTemplate"></ei-column>
                        <ei-column dataField="pessoa.cpf" caption="CPF" cellTemplate="cpfCellTemplate"></ei-column>
                        <ei-column dataField="status" caption="Status" editCellTemplate="statusEditCellTemplate" cellTemplate="statusCellTemplate"></ei-column>
                        <ei-column dataField="jaEscolheu" caption="Já escolheu" cellTemplate="jaEscolheuTpl"></ei-column>
                        <ei-column dataField="nomeMagicNumber" caption="Link mágico" cellTemplate="magicLinkCell"></ei-column>
                        <ei-column dataField="nomeMagicNumber" caption="Ações" cellTemplate="acoesCellTemplate"></ei-column>

                        <ng-template eTemplate="pessoaCellTemplate" let-data="data">{{ data.nome }}</ng-template>
                        <ng-template eTemplate="cpfCellTemplate" let-data="data">{{ data?.cpf || '-' }}</ng-template>
                        <ng-template eTemplate="statusCellTemplate" let-data="data">{{ statusEnumType[data].descricao }}</ng-template>
                        <ng-template eTemplate="jaEscolheuTpl" let-data="data">
                            <span [title]="data ? 'Já escolheu' : 'Ainda não'">{{ data ? '✔' : '✖' }}</span>
                        </ng-template>
                        <ng-template eTemplate="pessoaEditCellTemplate" let-row>
                            <p-select class="w-full" [(ngModel)]="row.pessoa" [options]="pessoasSugestoes"
                                      optionLabel="nome" dataKey="id" [filter]="true" filterBy="nome"
                                      (onFilter)="searchPessoas($event)" [showClear]="true" (onClear)="onPessoaLimpar(row.pessoa)"
                                      [ngModelOptions]="{standalone:true}" placeholder="Selecionar pessoa" appendTo="body">
                            </p-select>
                        </ng-template>

                        <ng-template eTemplate="statusEditCellTemplate" let-data="data">
                            <enum-select class="w-full" [enumObject]="statusEnumType" [ngModel]="data.status"
                                         (ngModelChange)="data.status = $event" [ngModelOptions]="{standalone:true}">
                            </enum-select>
                        </ng-template>

                        <ng-template eTemplate="magicLinkCell" let-data='data'>
                            <ng-container *ngIf="data; else semToken">
                                <a [href]="buildTokenLink(data)" target="_blank" rel="noopener">{{ data }}</a>
                            </ng-container>
                            <ng-template #semToken><span class="text-xs opacity-60">—</span></ng-template>
                        </ng-template>

                        <ng-template eTemplate="acoesCellTemplate" let-data='data'>
                            <button pButton type="button" icon="pi pi-external-link" class="p-button-text p-button-sm"
                                    pTooltip="Abrir Presente" [disabled]="!data" (click)="abrirPresente(data)"></button>
                            <button pButton type="button" icon="pi pi-copy" class="p-button-text p-button-sm"
                                    pTooltip="Copiar Link" [disabled]="!data" (click)="copiarLink(data)"></button>
                        </ng-template>

                    </e-data-grid>

                    <p-dialog [(visible)]="addPessoasDialogVisible" ... >
                    </p-dialog>
                </p-tabpanel>

                <p-tabpanel value="log" *ngIf="importacaoLogs.length > 0">
                    <div class="p-4 border border-red-200 rounded bg-red-50">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-red-700 font-bold text-lg">Relatório de Erros na Importação</h3>
                            <button pButton label="Limpar e Fechar" icon="pi pi-times"
                                    class="p-button-danger p-button-text"
                                    (click)="limparLogs()"></button>
                        </div>
                        <div class="max-h-[400px] overflow-y-auto bg-white p-2 border rounded shadow-sm">
                            <ul class="list-none m-0 p-0">
                                <li *ngFor="let log of importacaoLogs" class="py-2 border-b border-gray-100 text-sm text-gray-700 flex items-start gap-2">
                                    <i class="pi pi-times-circle text-red-500 mt-0.5"></i>
                                    <span>{{ log }}</span>
                                </li>
                            </ul>
                        </div>
                    </div>
                </p-tabpanel>

                <p-tabpanel value="produto"> ... </p-tabpanel>

            </p-tabpanels>
        </p-tabs>
    </div>
</crud>
<p-toast position="top-right" [breakpoints]="{'920px': {width: '100%', right: '0', left: '0'}}"></p-toast>
