<crud #crudRef [parent]="vm" listToolbarTitle="Clientes" editToolbarTitle="Editar Cliente"
      [collapsibleFilters]="true"
      [showListCloseButton]="true"
      [showListNewButton]="!isCliente()"
      [showEditSaveButton]="!isCliente()"
      [showEditNewButton]="!isCliente()"
      [showEditDeleteButton]="!isCliente()"
      (closeButtonAction)="onCloseCrud()">

  <!-- Filtros -->
  <div crud-list-filter-fields class="w-full text-left">
    <crud-filter
      [filter]="vm.filter"
      [fields]="filterFields"
      [loading]="false"
      (onSearch)="vm.doFilter().subscribe()"
      (onClear)="onClearFilters()"
    ></crud-filter>
  </div>

  <!-- Grid de listagem -->
  <div crud-list-grid class="w-full">
    <p-table [value]="vm.dataSource"
             [paginator]="true"
             [rows]="vm.filter.size || 10"
             [totalRecords]="vm.totalRecords"
             [lazy]="false"
             responsiveLayout="scroll"
             (onPage)="onPage($event)">
      <ng-template pTemplate="header">
        <tr>
          <th>Nome</th>
          <th>E-mail</th>
          <th>Telefone</th>
          <th>Usuário</th>
          <th style="width:1%">Ações</th>
        </tr>
      </ng-template>
      <ng-template pTemplate="body" let-row>
        <tr (dblclick)="crudRef.onRowDblClick(row)">
          <td>{{ row?.nome }}</td>
          <td>{{ row?.email }}</td>
          <td>{{ row?.telefone }}</td>
          <td>{{ row?.usuario?.username || '-' }}</td>
          <td>
            <!-- Editar disponível para todos os papéis -->
            <button pButton type="button" icon="pi pi-pencil" class="p-button-text p-button-sm" aria-label="Editar"
                    (click)="crudRef.onRowDblClick(row)"></button>
            <!-- Excluir somente para não-CLIENTE -->
            <button *ngIf="!isCliente()" pButton type="button" icon="pi pi-trash" class="p-button-text p-button-sm" aria-label="Excluir"
                    (click)="onDeleteRow(row)"></button>
          </td>
        </tr>
      </ng-template>
    </p-table>
  </div>

  <!-- Formulário de edição -->
  <div crud-edit-template class="grid grid-cols-1 gap-4 text-left justify-items-start w-full">
    <div class="grid grid-cols-1 gap-4 md:grid-cols-2 w-full">
      <div class="flex flex-col gap-2 w-full">
        <label class="block">Nome *</label>
        <input class="w-full" pInputText type="text" [(ngModel)]="vm.model.nome" name="nome" />
      </div>
      <div class="flex flex-col gap-2 w-full">
        <label class="block">Status</label>
        <p-select class="w-full"
                  [options]="statusOptions"
                  optionLabel="label" optionValue="value"
                  [(ngModel)]="vm.model['status']" name="status"
                  placeholder="Selecione"></p-select>
      </div>
      <div class="flex flex-col gap-2 w-full">
        <label class="block">E-mail</label>
        <input class="w-full" pInputText type="email" [(ngModel)]="vm.model.email" name="email" [disabled]="isCliente()" />
      </div>
      <div class="flex flex-col gap-2 w-full">
        <label class="block">Telefone</label>
        <input class="w-full" pInputText type="text" [(ngModel)]="vm.model.telefone" name="telefone" [disabled]="isCliente()" />
      </div>
      <div class="flex flex-col gap-2 w-full">
        <label class="block">Usuário</label>
        <p-select class="w-full"
                  [options]="usuariosOptions"
                  optionLabel="label" optionValue="value"
                  [ngModel]="getUsuarioIdFromModel()" name="usuario"
                  (ngModelChange)="vm.model['usuario'] = $event ? { id: $event } : null"
                  [disabled]="isCliente()"
                  placeholder="Selecione"></p-select>
      </div>
      <div class="flex flex-col gap-2 w-full md:col-span-2">
        <label class="block">Anotações</label>
        <textarea class="w-full" pInputText rows="4" [(ngModel)]="vm.model.anotacoes" name="anotacoes" [disabled]="isCliente()"></textarea>
      </div>
    </div>
  </div>

</crud>

<p-toast position="top-right" [breakpoints]="{'920px': {width: '100%', right: '0', left: '0'}}"></p-toast>
