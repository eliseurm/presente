
<div class="e-data-grid">
    <p-toast />

    <style>
        /* Mostrar o caption (rótulo da coluna) dentro da célula apenas em telas pequenas (stack) */
        @media (max-width: 768px) {
            .e-data-grid .p-column-title {
                display: inline-block;
                font-weight: 600;
                color: var(--text-color-secondary);
                margin-right: .5rem;
            }
        }
        @media (min-width: 769px) {
            .e-data-grid .p-column-title {
                display: none !important;
            }
        }
    </style>

    <!-- Toolbar com botão de adicionar -->
    <div class="erm-toolbar" *ngIf="editingConfig.allowAdding">
        <p-button
            label="Adicionar"
            icon="pi pi-plus"
            (onClick)="addNewRow()"
            [disabled]="loading"
            severity="primary">
        </p-button>
    </div>

    <!-- Tabela de dados - Responsiva -->
    <div class="table-responsive">
        <p-table
            [value]="dataSource"
            [loading]="loading"
            responsiveLayout="stack"
            breakpoint="768px"
            [scrollable]="scrollable"
            [scrollHeight]="scrollHeight"
            [paginator]="paginator"
            [rows]="rows"
            [rowsPerPageOptions]="rowsPerPageOptions"
            [totalRecords]="totalRecords"
            [lazy]="lazy"
            (onLazyLoad)="handleLazyLoad($event)"
            styleClass="p-datatable-striped"
            [(selection)]="selection"
            (selectionChange)="onSelectionChange($event)"
        >

            <ng-template pTemplate="header" let-columns>
                <tr>
                    <th style="width: 4rem" *ngIf="showSelection">
                        <p-tableHeaderCheckbox></p-tableHeaderCheckbox>
                    </th>
                    <th *ngFor="let col of visibleColumns">
                        {{ col.caption || col.dataField }}
                    </th>
                    <th *ngIf="editingConfig.allowUpdating || editingConfig.allowDeleting" style="width: 120px">
                        Ações
                    </th>
                </tr>
            </ng-template>

            <ng-template pTemplate="body" let-columns="columns" let-rowData>
                <tr [pSelectableRow]="rowData">
                    <td *ngIf="showSelection">
                        <p-tableCheckbox [value]="rowData"></p-tableCheckbox>
                    </td>
                    <td *ngFor="let col of visibleColumns">
                        <span class="p-column-title">{{ col.caption || col.dataField }}</span>
                        <ng-container *ngIf="!col.cellTemplate; else customCell">
                            {{ getCellValue(rowData, col) }}
                        </ng-container>
                        <ng-template #customCell>
                            <ng-container
                                *ngTemplateOutlet="getTemplate(col.cellTemplate!)!; context: { $implicit: rowData, data: getByPath(rowData, col.dataField) }">
                            </ng-container>
                        </ng-template>
                    </td>
                    <td *ngIf="editingConfig.allowUpdating || editingConfig.allowDeleting">
                        <span class="p-column-title">Ações</span>
                        <div class="action-buttons">
                            <p-button
                                *ngIf="editingConfig.allowUpdating"
                                icon="pi pi-pencil"
                                (onClick)="editRow(rowData)"
                                [text]="true"
                                severity="info"
                                size="small">
                            </p-button>
                            <p-button
                                *ngIf="editingConfig.allowDeleting"
                                icon="pi pi-trash"
                                (onClick)="deleteRow(rowData)"
                                [text]="true"
                                severity="danger"
                                size="small">
                            </p-button>
                        </div>
                    </td>
                </tr>
            </ng-template>

            <ng-template pTemplate="footer">
                <tr *ngIf="summariesEnabled">
                    <td *ngFor="let col of visibleColumns; let i = index">
                        {{ getFooterTextForColumn(col.dataField, i === 0) }}
                    </td>
                    <td *ngIf="editingConfig.allowUpdating || editingConfig.allowDeleting"></td>
                </tr>
            </ng-template>

            <ng-template pTemplate="emptymessage">
                <tr>
                    <td [attr.colspan]="visibleColumns.length + 1" class="empty-message">
                        Nenhum registro encontrado
                    </td>
                </tr>
            </ng-template>
        </p-table>
    </div>

    <!-- Dialog de edição - Responsivo -->
    <p-dialog
        [(visible)]="displayDialog"
        [header]="popupConfig.title"
        [modal]="true"
        [style]="{ width: popupConfig.width, maxWidth: '95vw', height: popupConfig.height }"
        [draggable]="false"
        [resizable]="false"
        [closable]="true"
        [closeOnEscape]="true"
        [breakpoints]="{ '960px': '90vw', '640px': '95vw' }"
        styleClass="erm-dialog">

        <style>
            /* Layout do formulário no popup */
            .erm-dialog .eo-form-grid {
                display: grid;
                gap: 1rem;
            }
            /* Telas pequenas: campos em coluna (vertical) */
            @media (max-width: 768px) {
                .erm-dialog .eo-form-grid {
                    grid-template-columns: 1fr !important;
                }
                .erm-dialog .eo-form-item {
                    grid-column: span 1 !important;
                }
            }
        </style>

        <!-- Renderização do conteúdo personalizado do formulário, permitindo HTML arbitrário (ex.: p-tabs) -->
        <ng-container *ngIf="editingRow && editing.form?.useContentProjection && editing.form?.contentTemplate">
            <!-- Fornece contexto e renderiza o template DENTRO do componente para garantir DI correto -->
            <eo-form-context
                [row]="editingRow"
                [isNewRow]="isNewRow"
                [columns]="visibleColumns"
                [templatesMap]="templatesMap"
                [getTemplate]="getTemplate.bind(this)"
                [setFormItemValue]="setFormItemValue.bind(this)"
                [getColumnByDataField]="getColumnByDataField.bind(this)"
                [hasError]="hasError.bind(this)"
                [getErrors]="getErrors.bind(this)"
                [isFieldRequired]="isFieldRequired.bind(this)"
                [template]="editing.form?.contentTemplate"
                [templateContext]="{ $implicit: editingRow, data: editingRow }">
            </eo-form-context>
        </ng-container>

        <!-- Renderização automática baseada em <ei-item> (desativada quando o conteúdo projetado está ativo) -->
        <div class="eo-form" *ngIf="editingRow && formItems && !(editing.form?.useContentProjection && editing.form?.contentTemplate)">
                <div class="eo-form-grid" [style.grid-template-columns]="'repeat(' + formColCount + ', 1fr)'">
                    <div *ngFor="let item of formItems"
                        class="eo-form-item"
                        [class.has-error]="hasError(item.dataField)"
                        [style.grid-column]="item.colSpan ? 'span ' + item.colSpan : 'span 1'">

                        <label [for]="item.dataField">
                            {{ getFormItemLabel(item) }}
                            <span *ngIf="isFieldRequired(item)" class="required-mark">*</span>
                        </label>

                        <!-- Campo de texto -->
                        <input
                            *ngIf="!getColumnByDataField(item.dataField)?.editCellTemplate && (!getColumnByDataField(item.dataField)?.dataType || getColumnByDataField(item.dataField)?.dataType === 'string')"
                            pInputText
                            [id]="item.dataField"
                            [(ngModel)]="editingRow[item.dataField]"
                            [ngModelOptions]="{standalone:true}"
                            (ngModelChange)="setFormItemValue(item.dataField, $event)"
                            [disabled]="item.dataField === 'id' && !isNewRow"
                            [class.ng-invalid]="hasError(item.dataField)"
                            [class.ng-dirty]="hasError(item.dataField)"
                            class="w-full" />

                        <!-- Campo numérico -->
                        <div *ngIf="!getColumnByDataField(item.dataField)?.editCellTemplate && getColumnByDataField(item.dataField)?.dataType === 'number'"
                             [class.field-error]="hasError(item.dataField)">
                            <p-inputnumber
                                [inputId]="item.dataField"
                                [(ngModel)]="editingRow[item.dataField]"
                                [ngModelOptions]="{standalone:true}"
                                (ngModelChange)="setFormItemValue(item.dataField, $event)"
                                styleClass="w-full">
                            </p-inputnumber>
                        </div>

                        <!-- Campo de data -->
                        <div *ngIf="!getColumnByDataField(item.dataField)?.editCellTemplate && getColumnByDataField(item.dataField)?.dataType === 'date'"
                             [class.field-error]="hasError(item.dataField)">
                            <p-datepicker
                                [inputId]="item.dataField"
                                [(ngModel)]="editingRow[item.dataField]"
                                [ngModelOptions]="{standalone:true}"
                                (ngModelChange)="setFormItemValue(item.dataField, $event)"
                                dateFormat="dd/mm/yy"
                                [showIcon]="true"
                                styleClass="w-full">
                            </p-datepicker>
                        </div>

                        <!-- Campo com lookup (dropdown) -->
                        <div *ngIf="!getColumnByDataField(item.dataField)?.editCellTemplate && getColumnByDataField(item.dataField)?.lookup"
                             [class.field-error]="hasError(item.dataField)">
                            <p-select
                                [inputId]="item.dataField"
                                [(ngModel)]="editingRow[item.dataField]"
                                [ngModelOptions]="{standalone:true}"
                                (ngModelChange)="setFormItemValue(item.dataField, $event)"
                                [options]="getColumnByDataField(item.dataField)!.lookup!.dataSource"
                                [optionLabel]="getColumnByDataField(item.dataField)!.lookup!.displayExpr"
                                [optionValue]="getColumnByDataField(item.dataField)!.lookup!.valueExpr"
                                [showClear]="true"
                                placeholder="Selecione..."
                                styleClass="w-full">
                            </p-select>
                        </div>

                        <!-- Template customizado -->
                        <ng-container *ngIf="getColumnByDataField(item.dataField)?.editCellTemplate">
                            <div [class.field-error]="hasError(item.dataField)">
                                <ng-container
                                    *ngTemplateOutlet="getTemplate(getColumnByDataField(item.dataField)!.editCellTemplate!)!;
                                    context: {
                                    $implicit: editingRow,
                                    data: editingRow,
                                    dataField: item.dataField,
                                    onChange: setFormItemValue.bind(this)
                                    }">
                                </ng-container>
                            </div>
                        </ng-container>

                        <!-- Mensagens de validação inline -->
                        <small *ngFor="let error of getErrors(item.dataField)" class="p-error">
                            {{ error }}
                        </small>
                    </div>
                </div>
        </div>

        <ng-template pTemplate="footer">
            <!-- Mensagem de validação animada -->
            <div class="validation-message-container" *ngIf="showValidationMessage" [@slideDown]>
                <p-message severity="error" [text]="validationMessage"></p-message>
            </div>

            <div class="dialog-footer-buttons">
                <p-button
                    label="Cancelar"
                    icon="pi pi-times"
                    (onClick)="closeDialog()"
                    severity="secondary">
                </p-button>
                <p-button
                    label="Salvar"
                    icon="pi pi-check"
                    (onClick)="saveRow()"
                    severity="primary">
                </p-button>
            </div>
        </ng-template>
    </p-dialog>

    <!-- Confirmation Dialog -->
    <p-confirmdialog></p-confirmdialog>
</div>
